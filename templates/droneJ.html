{% extends "index.html" %}
{% block title %}Drone {{ call_sign }}{% endblock %}

{% block content %}
  <h1 style="text-align: center;">Drone {{ call_sign }} In-Depth</h1>

  <!-- Split container with left for graphs and right for map -->
  <div class="drone-j-container" style="display: flex; width: 100%; height: 600px; padding: 0 20px;">
    
    <!-- Left side for the graphs -->
    <div class="graph-container" style="width: 40%; padding: 0px;">
      <div id="graph1" style="height: 250px; width: 100%; max-width: 700px;"></div>
      <div id="graph2" style="height: 250px; width: 100%; max-width: 700px;"></div>
      <div id="graph3" style="height: 250px; width: 100%; max-width: 700px;"></div>
    </div>

    <!-- Right side for the map -->
    <div class="map-container" style="width: 60%; padding: 20px;">
      <div id="map" style="height: 70vh; width: 100%; border-radius: 10px; box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);"></div>
    </div>

  </div>
  <!-- External Libraries -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="{{ url_for('static', filename='js/map.js') }}"></script>

  <!-- Real-time Graph Update Script -->
  <script>
    const callSign = "{{ call_sign }}"; // current callsign

    // Graph 1: airspeed & altitude
    let graph1Time = [], graph1Airspeed = [], graph1Altitude = [], graph1Counter = 0;
    // Graph 2: instant deviation
    let graph2Counter = 0;
    // Graph 3: cumulative deviation over 25 ft
    let graph3Time = [], graph3CumDevSum = [], graph3Counter = 0;

    function SingleJSONupdateGraphs(data) {
      if (!data 
       || !data.velocity 
       || !data.position 
       || data.cumulative_dev_sum === undefined
      ) return;

      // Graph 1 updates
      graph1Counter++;
      graph1Time.push(graph1Counter);
      const airspeed_knots = data.velocity.airspeed * 1.94384;
      graph1Airspeed.push(airspeed_knots);
      graph1Altitude.push(data.position.altitude);
      Plotly.extendTraces('graph1', {
        x: [[graph1Counter], [graph1Counter]],
        y: [[airspeed_knots], [data.position.altitude]]
      }, [0, 1]);

      // Graph 2 updates
      graph2Counter++;
      const barColor = data.deviation > 25 ? 'red' : 'blue';
      Plotly.extendTraces('graph2', {
        x: [[graph2Counter]],
        y: [[data.deviation]],
        'marker.color': [[barColor]]
      }, [0]);

      // Graph 3 updates
      graph3Counter++;
      graph3Time.push(graph3Counter);
      graph3CumDevSum.push(data.cumulative_dev_sum);
      Plotly.extendTraces('graph3', {
        x: [[graph3Counter]],
        y: [[data.cumulative_dev_sum]]
      }, [0]);
    }

    function SLOWupdateGraphs(dataArray) {
      if (!Array.isArray(dataArray) || dataArray.length === 0) {
        console.warn("Empty or invalid data");
        return;
      }
      dataArray.forEach(data => {
        if (!data 
         || !data.velocity 
         || !data.position 
         || data.cumulative_dev_sum === undefined
        ) return;

        // Graph 1
        graph1Counter++;
        graph1Time.push(graph1Counter);
        const airspeed_knots = data.velocity.airspeed * 1.94384;
        graph1Airspeed.push(airspeed_knots);
        graph1Altitude.push(data.position.altitude);
        Plotly.extendTraces('graph1', {
          x: [[graph1Counter], [graph1Counter]],
          y: [[airspeed_knots], [data.position.altitude]]
        }, [0, 1]);

        // Graph 2
        graph2Counter++;
        const barColor = data.deviation > 25 ? 'red' : 'blue';
        Plotly.extendTraces('graph2', {
          x: [[graph2Counter]],
          y: [[data.deviation]],
          'marker.color': [[barColor]]
        }, [0]);

        // Graph 3
        graph3Counter++;
        graph3Time.push(graph3Counter);
        graph3CumDevSum.push(data.cumulative_dev_sum);
        Plotly.extendTraces('graph3', {
          x: [[graph3Counter]],
          y: [[data.cumulative_dev_sum]]
        }, [0]);
      });
    }

    function loadHistoricalGraph(dataArray) {
      const time = dataArray.map((_, i) => i + 1);
      const airspeeds = dataArray.map(d => d.velocity.airspeed * 1.94384);
      const altitudes = dataArray.map(d => d.position.altitude);
      const deviations = dataArray.map(d => d.deviation);
      const cumDevs    = dataArray.map(d => d.cumulative_dev_sum || 0);
      const deviationColors = deviations.map(d => d > 25 ? 'red' : 'blue');

      // initialize graph 1 data
      graph1Time      = time.slice();
      graph1Airspeed  = airspeeds.slice();
      graph1Altitude  = altitudes.slice();
      graph1Counter   = time.length;

      // initialize graph 2 data
      graph2Counter   = time.length;

      // initialize graph 3 data
      graph3Time      = time.slice();
      graph3CumDevSum = cumDevs.slice();
      graph3Counter   = time.length;

      Plotly.newPlot('graph1', [
        { x: time, y: airspeeds, mode: 'lines', name: 'Airspeed (knots)' },
        { x: time, y: altitudes, mode: 'lines', name: 'Altitude (ft)', yaxis: 'y2' }
      ], {
        title: 'Airspeed and Altitude over Time',
        xaxis: { title: 'Time (s)' },
        yaxis: { title: 'Airspeed (knots)' },
        yaxis2:{ title: 'Altitude (ft)', overlaying:'y', side:'right' }
      });

      Plotly.newPlot('graph2', [{
        x: time,
        y: deviations,
        type: 'bar',
        marker: { color: deviationColors }
      }], {
        title: 'Deviation from Course (ft)',
        xaxis:{ title:'Update #' },
        yaxis:{ title:'Deviation (ft)', range:[0,50] }
      });

      Plotly.newPlot('graph3', [
        { x: time, y: cumDevs, mode: 'lines+markers', name: 'Cumulative Deviation > 25 ft' }
      ], {
        title: 'Cumulative Deviation â‰¥ 25 ft over Time',
        xaxis:{ title:'Time (s)' },
        yaxis:{ title:'Total Deviation (ft)', autorange:true }
      });
    }

    // Initial load
    loadHistoricalGraph([]);
    // Fetch full history once
    fetch(`/data/${callSign}`)
      .then(res => res.json())
      .then(data => loadHistoricalGraph(data))
      .catch(err => console.error(err));

    // Poll for new data every second
    setInterval(() => {
      fetch(`/data/${callSign}`)
        .then(res => res.json())
        .then(dataArray => {
          if (!Array.isArray(dataArray) || dataArray.length === 0) return;
          const newPoints = dataArray.slice(graph1Counter);
          newPoints.forEach(point => SingleJSONupdateGraphs(point));
        })
        .catch(err => console.error(err));
    }, 1000);

  </script>
{% endblock %}